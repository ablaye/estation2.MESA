#!/bin/sh

# TODO: 
#   -> Define the base_dir for DB creation in a config file and source it (or set the env var PGDATA)
#   -> Improve the mechanism to create the DB ? Test "$(ls $base_dir_db_data |wc -l)" = 0 NOT very safe ..
#   -> Source user credentials from a config file ?
#

# Define a logfile
mkdir -p /var/log/eStation2/  
logfile=/var/log/eStation2/upgrade_ps-database_2.0.1.log

uname=$(uname -n)
echo "Machine Name = ${uname}" >> ${logfile}

# --------------------------------------------------------------------------------------
#	Common Definitions
# --------------------------------------------------------------------------------------
# Define base dirs (to be moved somewhere else and sourced)
base_dir_db_data="/eStation2/dbdata/"	# it is to be on Disk1 (system)
base_dir_system="/srv/www/eStation2/"	# it is to be on Disk2 (system)
base_dir_data="/data/"			# it is to be on Disk2 (data)

# --------------------------------------------------------------------------------------
#	Postgresql DB management
#	- initialize postgres datadir (in installation from scratch)
#	- do a (partial) dump 	      (in case of upgrade)
# --------------------------------------------------------------------------------------

mkdir -p $base_dir_db_data
chown -R postgres:postgres $base_dir_db_data
 
# Stop postgresql if it is running
if [ "$(nc -v -z localhost 5432 2> /dev/null;echo $?)" = 0 ]; then
	/etc/init.d/postgresql stop
fi

# first database connection
if [ "$(ls $base_dir_db_data|wc -l)" = 0 ];then
	su postgres -c "/usr/lib/postgresql/9.3/bin/initdb -D $base_dir_db_data"
fi

#Create the .pgpass file
echo 'localhost:5432:estationdb:estation:mesadmin' >> /home/adminuser/.pgpass
chmod 600 /home/adminuser/.pgpass

#End of Modification of the Configuration
ln -sf /etc/postgresql-common/root.crt "$base_dir_db_data/root.crt"
ln -sf /etc/ssl/certs/ssl-cert-snakeoil.pem "$base_dir_db_data/server.crt"
ln -sf /etc/ssl/private/ssl-cert-snakeoil.key "$base_dir_db_data/server.key"

#Write to tmpfile the actual version of package (if is an upgrade). This is for postinst.
old_package=$(dpkg -l|grep eStation-Apps|awk '{print $3}'|cut -d '-' -f1)
if [ "${old_package}" ];then
	mkdir -p -m 755 "$base_dir_system/database"
	touch "$base_dir_system/database/version_${old_package}"
fi

# Restart the database
/etc/init.d/postgresql start

# Do a dump of DB structure - ONLY if it is an update (not for installation from scratch) 
if [ ! -z "${old_package}" ];then
  mkdir -p "$base_dir_data/dbbackup"
  pg_dump -i -h localhost -p 5432 -U estation -c -s -F p -v -f "$base_dir_data/dbbackup/full_dump_structure_${old_package}.sql" -n \"products\" -n \"data\" -n \"analysis\" estationdb
  # Do a dump of data (except timeseries_data: -T "ps.timeseries_data")
  pg_dump -i -h localhost -p 5432 -U estation -a -b -F t -v -f "$base_dir_data/dbbackup/full_dump_data_${old_package}.sql" -n \"products\" -n \"data\" -n \"analysis\" estationdb
fi

